# 云聚-CRM：多智能体客户服务平台

本项目是一个使用 Next.js, Genkit, 和 TypeScript 构建的现代化、功能丰富的多智能体客户服务（CRM）平台。它提供了一整套从管理员、坐席到访客的完整解决方案，并集成了先进的AI能力。

## 🚀 快速开始

- 安装依赖并一键启动（Next.js 前端 + 本地 WebSocket 服务）
  - npm install
  - npm run dev:full
  - 前端：http://localhost:3001
- 管理员登录
  - 在登录页直接输入 .env 中的 ADMIN_KEY（默认 admin8888）
- 生成坐席密钥
  - 进入“密钥管理”，选择类型为 agent，创建密钥并复制
- 坐席登录（已支持首次登录自动创建并绑定坐席）
  - 退出登录，用刚才复制的 agent 密钥直接登录，会自动创建并绑定一个新坐席，进入 /agent 工作台
- 生成分享链接（对外 1 对多）
  - 坐席左下角头像 → 分享聊天链接 → 复制 /naoiod/{token} 链接或下载二维码
  - 把链接发给用户即可，一个坐席可以同时接待多个访客

## ✅ 最小流程说明

1) 管理员用 ADMIN_KEY 登录 → 2) 管理面板创建 agent 密钥 → 3) 坐席用该密钥直接登录（首登自动建档并绑定） → 4) 生成分享链接 → 5) 访客打开链接开始聊天（坐席端左侧可看到多个会话并切换）

注：WebSocket 服务用于更好的实时体验；如果未启动，系统仍可通过轮询正常工作。

## ✨ 核心功能

- **管理员仪表盘**:
  - **密钥管理**: 创建、查看、编辑和管理用于登录系统的访问密钥（坐席或管理员类型）。
  - **坐席管理**: 统一查看系统内所有坐席的状态、活动和绑定的密钥。
  - **数据统计**: 概览平台核心指标，如坐席总数、在线人数、密钥状态等。

- **坐席工作台**:
  - **实时聊天**: 与来自不同渠道的访客进行实时、一对一的沟通。
  - **会话管理**: 清晰的会话列表，可以切换、归档和恢复聊天。
  - **客户信息面板**: 在聊天时可以随时查看访客的详细信息（如IP、地理位置、设备等）。
  - **快捷回复**: 设置并使用常用语，一键发送，提升响应效率。
  - **智能辅助**: 内置基于 Genkit 的 PII（个人身份信息）一键脱敏功能，确保对话安全。

- **访客聊天界面**:
  - 通过唯一的分享链接或二维码，访客可以轻松地与指定坐席建立聊天会话。

- **动态密钥与分享链接系统**:
  - **固定到期点**: 密钥具有固定的每日到期时间点（例如 12:00 或 00:00），增强安全性。
  - **替换式绑定**: 坐席通过绑定一个有效的、未使用的密钥来获取或延长访问权限，旧密钥立即失效。
  - **同步失效的分享链接**: 坐席可以生成与当前密钥有效期同步的分享链接和二维码。当坐席更换密钥后，旧的分享链接将自动作废，需要重新生成。

- **流程总结**
- 管理员获取密钥 → createKey()
- 客服登录密钥绑定 → bindKeyToUser   (userId, key)
- 生成短链/QR码分享 → generateShortLink(shareId, key)
- 访问短链 → resolveShortLink(token) 校验是否过期
- 密钥续期/延续 → renewKeyForUser(userId)，旧密钥失效，新密钥绑定，短链重新生成
- 定时清理 → 内存自动删除过期密钥和短链

- **密钥与短链管理流程图文字版示意**

- [管理员生成密钥] 
        │ createKey()
        ▼
- [密钥内存池存储] ──► expireAt计算 (按0点/12点对齐)
        │
        ▼
- [客服绑定密钥登录] 
        │ bindKeyToUser(userId, key)
        │  └─> 校验是否过期
        ▼
- [密钥绑定成功] ──► 可使用生成短链
        │
        ▼
- [生成短链/QR码] 
        │ generateShortLink(shareId, key)
        │  └─> 短链 expireAt = 密钥 expireAt
        ▼
- [用户扫码/访问短链] 
        │ resolveShortLink(token)
        │  └─> 校验是否过期
        ▼
- [访问 naoiod/{token} 页面]
        │
        ▼
- [密钥过期] 
        │  └─> 定时清理 / 立即解绑
        ▼
- [可续期/延续密钥]
        │ renewKeyForUser(userId)
        │  └─> 新密钥绑定，旧密钥失效，短链重新生成
        ▼
- [新的有效密钥 & 短链继续使用]

## 🛠️ 核心设计要点

- **密钥到期时间对齐**

- **0点后领取 → 到当天12点过期**

- **12点后领取 → 次日0点过期**

- **密钥续期/延续**

- **可以生成新密钥绑定到同一客服**

- **旧密钥立即失效**

- **短链可重新绑定新密钥延长有效期**

- **短链与密钥关联**

- **短链有效期 = 绑定密钥的 expireAt**

- **校验短链时自动检测密钥是否有效**

- **内存管理**

- **每分钟定时清理过期密钥和短链**

- **保证内存不会无限累积**

## 🛠️ 技术栈

- **前端框架**: [Next.js](https://nextjs.org/) (使用 App Router)
- **编程语言**: [TypeScript](https://www.typescriptlang.org/)
- **UI 组件库**: [ShadCN/UI](https://ui.shadcn.com/)
- **样式方案**: [Tailwind CSS](https://tailwindcss.com/)
- **AI 集成**: [Genkit (by Firebase)](https://firebase.google.com/docs/genkit)
- **状态管理**: [Zustand](https://github.com/pmndrs/zustand)
- **图标库**: [Lucide React](https://lucide.dev/)
- **日期处理**: [date-fns](https://date-fns.org/)
